/*
 * Author: Pius Meinert 
 * TODO: dummyTimer really needed? 
 * */

using System;
using ConversionOfBrutes.GameObjects;
using Microsoft.Xna.Framework;

namespace ConversionOfBrutes.AI.States
{
	[Serializable]
	sealed class AttackState : BaseState
	{
		private AiSquad mAiSquad;
		private int mDummyTimer;
		private readonly Unit mTargetUnit;

		public AttackState(AiSquad aiSquad, Unit targetUnit)
		{
			mAiSquad = aiSquad;
			mTargetUnit = targetUnit;
		}

		public override void Update()
		{
			if (mTargetUnit.IsDead() || mDummyTimer++ > 50)
			{
				mDummyTimer = 0;
				mAiSquad.States.Pop();
			}
			else
			{
				foreach (Unit squadMember in mAiSquad.SquadMembers)
				{
					if ((squadMember.Ident == Ident.Archer || squadMember.Ident == Ident.ArcherMounted) &&
					    squadMember.Attacking &&
					    Vector2.Distance(squadMember.TargetUnit.Position, squadMember.Position) < squadMember.AttackRange - 10)
					{
						Vector2 kiteDirection = squadMember.Position - squadMember.TargetUnit.Position;
						kiteDirection.Normalize();
						squadMember.WalkToPosition(kiteDirection * 5 + squadMember.Position, 0);
					}
					if (!squadMember.Attacking)
					{
						squadMember.Attack(mTargetUnit);
					}
				}
			}
		}
	}
}
