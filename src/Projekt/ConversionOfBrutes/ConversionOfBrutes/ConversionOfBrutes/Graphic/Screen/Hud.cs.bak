/**
 * Author: David Spisla, buerklij + derjenige, der die Klasse erstellt hat
 * 
 * Concrete Class for the HUD
 * Usage: This Class Implements the HUD which is used in the GameScreen class 
 * Missing: 
 * - functionality of all buttons
 **/

//#define PIUS

using System;
using System.Collections.Generic;
using System.Linq;
using ConversionOfBrutes.GameLogics;
using ConversionOfBrutes.GameObjects;
using ConversionOfBrutes.Map;
using ConversionOfBrutes.Misc;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using Microsoft.Xna.Framework.Input;


namespace ConversionOfBrutes.Graphic.Screen
{
	internal sealed class Hud : Screen
	{
		private readonly DeveloperInformation mDeveloperInformation = new DeveloperInformation();

		private bool mOnlySelectedHealthBars = true;

		private SpriteBatch mSpriteBatch;
		private Texture2D mHud;
		private Rectangle mHudRectangle;
		private Rectangle mUpperHudRectangle;
		private Rectangle mLowerHudRectangle;
		private Rectangle mMiniMapRectangle;
		private List<MenuButton> mItems;
		private List<ActionButton> mActionButtons;

		private MenuLabel mWinPoints;
		private MenuLabel mContingent;

		private MenuLabel mFps;
		private MenuLabel mDeveloperInfo;
		private List<Thumbnail> mThumbNails;
		private List<Healthbar> mHealthbars;
		private LinkedList<SpawnJob> mSpawnQueue;
		private MenuLabel mThumbNailInfo;
		private Texture2D mSelectionButtons;

		private MiniMap mMiniMap;

		public Hud()
		{
			Initialize();
		}


		public override void Initialize()
		{
			GraphicsDeviceManager graphics = Main.Graphics;
			mScreenWidth = graphics.PreferredBackBufferWidth;
			mScreenHeight = graphics.PreferredBackBufferHeight;


			mSpriteBatch = new SpriteBatch(graphics.GraphicsDevice);
			mHud = Main.Content.Load<Texture2D>("HUD\\Hud");
			mHudRectangle = ScaledRectangle(0, 0, 1920, 1080);
			mUpperHudRectangle = ScaledRectangle(0, 0, 1920, 57);
			mLowerHudRectangle = ScaledRectangle(0, 841, 1920, 1080 - 841);
			mMiniMapRectangle = ScaledRectangle(15, 860, 300, 210);

			mItems = new List<MenuButton>();


			MenuButton inGameMenuButton = new MenuButton(MenuItem.MenuIdentifier.InGameMenu, ScaledRectangle(0, 0, 120, 50));
			mWinPoints = new MenuLabel(MenuItem.MenuIdentifier.Label, ScaledRectangle(775, 15, 0, 0), "Atlantis: | :Barbarians");
			mContingent = new MenuLabel(MenuItem.MenuIdentifier.Label, ScaledRectangle(1600, 15,0,0), "");
			mFps = new MenuLabel(MenuItem.MenuIdentifier.Label, ScaledRectangle(150, 15, 0, 0), "");
			mDeveloperInfo = new MenuLabel(MenuItem.MenuIdentifier.Label, ScaledRectangle(300, 15, 0, 0), "");

			mThumbNails = new List<Thumbnail>();
			mHealthbars = new List<Healthbar>();
			mSpawnQueue = new LinkedList<SpawnJob>();
			mActionButtons = new List<ActionButton>();
			mSelectionButtons = Main.Content.Load<Texture2D>("Button//SelectionButtons");

			mItems.Add(inGameMenuButton);

			mMiniMap = new MiniMap(mMiniMapRectangle);

#if DEBUG
			mDeveloperInformation.ShowFps = true;
			mDeveloperInformation.ShowDeveloperInfo = true;
#endif

		}

		public override void Update(GameTime gameTime)
		{
			Point point1 = new Point((int)Main.Input.GetCurrentMousePosition().X, (int)Main.Input.GetCurrentMousePosition().Y);

			foreach (MenuButton button in mItems)
			{
				button.CheckIsMouseOver(point1);
			}
			
			var selectedObjects = GameScreen.ObjectManager.SelectionHandler.SelectedObjects;

			mWinPoints.Text = "Atlantis:" + (int) GameScreen.GameLogic.AtlantisPoints + " | " +
			                  (int) GameScreen.GameLogic.BarbPoints + ":Barbarians";
			mContingent.Text = "Contingent: " + GameScreen.GameLogic.AtlantisContingent;
			if (mDeveloperInformation.ShowFps)
				mFps.Text = "FPS: " + GameScreen.Fps;
			HandleSelectedObjects(selectedObjects);
			HandleMouse(selectedObjects);
			HandleKeyboard(selectedObjects);

			mMiniMap.Update();
		}


		public override void Draw()
		{
			mSpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend);


			// Draw the Healthbars
			foreach (var bar in mHealthbars)
			{
				bar.Draw();
			}

			mSpriteBatch.Draw(mHud, mHudRectangle, Color.White);

			mSpriteBatch.DrawString(mWinPoints.GetFont(),
				mWinPoints.Text,
				new Vector2(mWinPoints.Rectangle.X, mWinPoints.Rectangle.Y),
				Color.AliceBlue, 0f, Vector2.Zero, 2*(mScreenWidth / 1920f), SpriteEffects.None, 0f);

			mSpriteBatch.DrawString(mContingent.GetFont(),
				mContingent.Text,
				new Vector2(mContingent.Rectangle.X, mContingent.Rectangle.Y),
				Color.AliceBlue, 0f, Vector2.Zero, 2 * (mScreenWidth / 1920f), SpriteEffects.None, 0f);

			if (mDeveloperInformation.ShowFps)
				mSpriteBatch.DrawString(mFps.GetFont(), mFps.Text, new Vector2(mFps.Rectangle.X, mFps.Rectangle.Y), Color.AliceBlue);

			if (mDeveloperInformation.ShowDeveloperInfo)
			{ 
				mSpriteBatch.DrawString(mDeveloperInfo.GetFont(),
				mDeveloperInfo.Text,
				new Vector2(mDeveloperInfo.Rectangle.X, mDeveloperInfo.Rectangle.Y),
				Color.AliceBlue);
			}

			foreach (MenuButton item in mItems)
			{
				mSpriteBatch.Draw(item.Texture, item.Rectangle, Color.White);
			}

			// Draw thumbnails of all selected objects
			foreach (var thumbNail in mThumbNails)
			{
				if (mThumbNails.Count == 1)
				{
					Vector2 pos = new Vector2(mThumbNailInfo.Rectangle.X, mThumbNailInfo.Rectangle.Y);
					mSpriteBatch.DrawString(mThumbNailInfo.GetFont(),
						mThumbNailInfo.Text,
						pos,
						Color.Black,
						0f,
						Vector2.Zero,
						1f,
						SpriteEffects.None,
						0f);
				}
				thumbNail.Draw();

			}

			// Draw SpawnQueue
			foreach (var job in mSpawnQueue)
			{
				job.Draw();
			}

			// Place the Action buttons in the HUD
			foreach (var button in mActionButtons)
			{
				button.Draw();
			}

			// Minimap
			Texture2D miniMap = mMiniMap.MiniMapTexture;
			if (miniMap != null)
			{
				Rectangle rec = mMiniMapRectangle;
				mSpriteBatch.Draw(miniMap, rec, Color.White);
			}

			mSpriteBatch.End();

			foreach (MenuButton button in mItems)
			{
				button.DrawButton();
			}

			Main.Graphics.GraphicsDevice.BlendState = BlendState.Opaque;
			Main.Graphics.GraphicsDevice.DepthStencilState = DepthStencilState.Default;
			Main.Graphics.GraphicsDevice.SamplerStates[0] = SamplerState.LinearWrap;
		}

		private void HandleMouse(LinkedList<WorldObject> selectedObjects)
		{
			if (Main.Input.MouseClicked())
			{
				Point point = new Point((int) Main.Input.MouseClickPosition().X, (int) Main.Input.MouseClickPosition().Y);

				if (mLowerHudRectangle.Contains(point) || mUpperHudRectangle.Contains(point))
				{
					foreach (MenuItem item in mItems)
					{
						if (item.Rectangle.Contains(point))
						{
							switch (item.Identifier)
							{
								case MenuItem.MenuIdentifier.InGameMenu:
									StartIngameMenu();
									break;
							}
						}
					}

					foreach (var button in mActionButtons)
					{
						if (button.DestRect.Contains(point))
						{
							GameScreen.ObjectManager.SelectionHandler.AttackButton = false;
							GameScreen.ObjectManager.SelectionHandler.AttackMoveButton = false;
							GameScreen.ObjectManager.SelectionHandler.MoveButton = false;
							GameScreen.ObjectManager.SelectionHandler.PatrolButton = false;
							var buttonAction = button.Action;
							switch (buttonAction)
							{
								case ActionButton.ActionIdent.Attack:
									GameScreen.ObjectManager.SelectionHandler.AttackButton = true;
									break;
								case ActionButton.ActionIdent.AttackMove:
									GameScreen.ObjectManager.SelectionHandler.AttackMoveButton = true;
									break;
								case ActionButton.ActionIdent.Move:
									GameScreen.ObjectManager.SelectionHandler.MoveButton = true;
									break;
								case ActionButton.ActionIdent.Patrol:
									GameScreen.ObjectManager.SelectionHandler.PatrolButton = true;
									break;
								case ActionButton.ActionIdent.Stop:
									GameScreen.ObjectManager.StopSelectedUnits();
									break;
								case ActionButton.ActionIdent.Taunt:
									GameScreen.ObjectManager.CastTaunt();
									break;
								case ActionButton.ActionIdent.SpawnPriest:
									GameScreen.GameLogic.SpawnUnit(Ident.Priest, (SpawnZone)selectedObjects.First.Value, Fraction.Player);
									UpdateSpawnQueue(selectedObjects.First.Value);
								    Main.mGameStatistic.RecruitedUnits++;
									break;
								case ActionButton.ActionIdent.SpawnShieldguard:
									GameScreen.GameLogic.SpawnUnit(Ident.ShieldGuard, (SpawnZone)selectedObjects.First.Value, Fraction.Player);
									UpdateSpawnQueue(selectedObjects.First.Value);
									Main.mGameStatistic.RecruitedUnits++;
									break;
								case ActionButton.ActionIdent.SpawnRangedPriest:
									GameScreen.GameLogic.SpawnUnit(Ident.PriestRanged, (SpawnZone)selectedObjects.First.Value, Fraction.Player);
									UpdateSpawnQueue(selectedObjects.First.Value);
									Main.mGameStatistic.RecruitedUnits++;
									break;
								case ActionButton.ActionIdent.SpawnEliteAtlantican:
									GameScreen.GameLogic.SpawnUnit(Ident.EliteAtlantic, (SpawnZone)selectedObjects.First.Value, Fraction.Player);
									UpdateSpawnQueue(selectedObjects.First.Value);
									Main.mGameStatistic.RecruitedUnits++;
									break;

							}
						}
					}

					foreach (var thumbNail in mThumbNails)
					{
						if (thumbNail.DestRect.Contains(point))
						{
							LinkedList<WorldObject> dmy = new LinkedList<WorldObject>();
							dmy.AddFirst(thumbNail.RepresentedObject);
							GameScreen.ObjectManager.SelectionHandler.SelectedObjects = dmy;
						}
					}

					foreach (var job in mSpawnQueue)
					{
						if (job.DestRect.Contains(point))
						{
							GameScreen.GameLogic.CancelSpawn(job);
							break;
						}
					}

					// moves camera to clicked point
					if (mMiniMapRectangle.Contains(point))
					{
						MiniMapClickEvent(point);
					}
				}
				else
				{
					Main.Input.MouseClickNotUsed();
				}
			}
		}

		private void HandleKeyboard(LinkedList<WorldObject> selectedObjects)
		{
			// Cast Taunt (Shieldguard)
			if (Main.Input.WasButtonPressed(GameScreen.HotKey.GetHotkey(HotKeys.HotKey.Taunt)))
				GameScreen.ObjectManager.CastTaunt();

			// Spawn Unit (When Spawnzone is selected)
			if (selectedObjects.Count > 0 && selectedObjects.First.Value is SpawnZone)
			{
				Ident spawnUnit = Ident.Rock;
				
				if (Main.Input.WasButtonPressed(GameScreen.HotKey.GetHotkey(HotKeys.HotKey.SpawnShieldGuard)))
				{
					spawnUnit = Ident.ShieldGuard;
				}
				else if (Main.Input.WasButtonPressed(GameScreen.HotKey.GetHotkey(HotKeys.HotKey.SpawnPriest)))
				{
					spawnUnit = Ident.Priest;
				}
				else if (Main.Input.WasButtonPressed(GameScreen.HotKey.GetHotkey(HotKeys.HotKey.SpawnRangedPriest)))
				{
					spawnUnit = Ident.PriestRanged;
				}
				else if (Main.Input.WasButtonPressed(GameScreen.HotKey.GetHotkey(HotKeys.HotKey.SpawnEliteAtlantican)))
				{
					spawnUnit = Ident.EliteAtlantic;
				}
				// you cannot spawn a rock 
				if (spawnUnit != Ident.Rock)
				{ 
					GameScreen.GameLogic.SpawnUnit(Ident.ShieldGuard, (SpawnZone)selectedObjects.First.Value, Fraction.Player);
					UpdateSpawnQueue(selectedObjects.First.Value);
				}
			}

			for (int i = 0; i < HotKeys.HotKey.Group9 - HotKeys.HotKey.Group0; i++)
			{
				var currentGroup = HotKeys.HotKey.Group0 + i;
				// Group units 
				if (Main.Input.CtrlDownAndButtonPressed(GameScreen.HotKey.GetHotkey(currentGroup)))
					GameScreen.ObjectManager.SelectionHandler.GroupObjects(i);
				// Select Groups 0-9
				else if (Main.Input.WasButtonPressed(GameScreen.HotKey.GetHotkey(currentGroup)))
					GameScreen.ObjectManager.SelectionHandler.SelectGroup(i);
			}

			// Ingame Menu
			if (Main.Input.WasButtonPressed(Keys.Escape))
			{
				StartIngameMenu();
			}
			else if (Main.Input.WasButtonPressed(Keys.F1))
			{
				mDeveloperInformation.ShowFps = !mDeveloperInformation.ShowFps;
			}
			else if (Main.Input.WasButtonPressed(Keys.F2))
			{
				mDeveloperInformation.ShowUnitInfo = !mDeveloperInformation.ShowUnitInfo;
			}
			else if (Main.Input.WasButtonPressed(Keys.F3))
			{
				mDeveloperInformation.ShowDeveloperInfo = !mDeveloperInformation.ShowDeveloperInfo;
			}
			else if (Main.Input.WasButtonPressed(Keys.F4))
			{
				GameScreen.ObjectManager.SpawnUnits(true, 1);
			}
			else if (Main.Input.WasButtonPressed(Keys.F5))
			{
				GameScreen.ObjectManager.SpawnUnits(false, 20);
			}
		}

		private void StartIngameMenu()
		{
			UpdateDeactivate();
			//DrawDeactivate();
			mManager.GetSecondPeek().UpdateDeactivate();
			//mManager.GetSecondPeek().DrawDeactivate();
			mManager.AddScreen(new InGameMenuScreen());
		}

		/// <summary>
		/// moves camera to the clicked position
		/// </summary>
		/// <param name="mousePos"></param>
		private void MiniMapClickEvent(Point mousePos)
		{
			double miniMapX = (double) (mousePos.X - mMiniMapRectangle.X) / mMiniMapRectangle.Width;
			double miniMapY = (double) (mousePos.Y - mMiniMapRectangle.Y) / mMiniMapRectangle.Height;

			Rectangle mapRect = GameScreen.Map.QuadRect;

			Vector2 mapPosition = new Vector2((float) (miniMapX * mapRect.Width), (float) (miniMapY * mapRect.Height));

			if (Main.Input.UsedMouseButton == InputManager.MouseButton.Left)
			{
				GameScreen.Camera.GotoWorldPosition(mapPosition);
			}
			// rechte Maustaste
			else
			{
				GameScreen.ObjectManager.SendSelectedUnits(mapPosition);
			}
		}

		private void HandleSelectedObjects(LinkedList<WorldObject> selectedObjects)
		{
			bool newSelection = false;

			if (GameScreen.ObjectManager.SelectionHandler.NewSelection)
			{
				newSelection = true;
				int cntUnits = 0;
				mThumbNails.Clear();
				mActionButtons.Clear();
				mSpawnQueue = new LinkedList<SpawnJob>();

				foreach (var obj in selectedObjects)
				{
					//Create thumbnails
					Rectangle thumbRect;
					thumbRect = selectedObjects.Count == 1
						? ScaledRectangle(490, 875, 180, 180)
						: ScaledRectangle(490 + (cntUnits % 18) * 60, 875 + (cntUnits / 18) * 60, 60, 60);

					mThumbNails.Add(new Thumbnail(obj, mSelectionButtons, thumbRect, mSpriteBatch));

					cntUnits++;
				}

				// decide whitch ActionIdent buttons should be shown
				if (selectedObjects.Count != 0 && selectedObjects.First.Value.Fraction == Fraction.Player)
				{
					if (selectedObjects.Any(ob => ob.Ident == Ident.Spawnzone))
					{
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.SpawnPriest));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.SpawnShieldguard));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.SpawnRangedPriest));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.SpawnEliteAtlantican));
					}
					else if (!(selectedObjects.First.Value is Zone))
					{
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.Attack));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.Move));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.AttackMove));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.Patrol));
						mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.Stop));

						if (selectedObjects.Any(ob => ob.Ident == Ident.ShieldGuard))
						{
							mActionButtons.Add(new ActionButton(mSelectionButtons, mSpriteBatch, ActionButton.ActionIdent.Taunt));
						}
					}
				}
				int num = 0;
				foreach (var button in mActionButtons)
				{
					Rectangle destRectangle = ScaledRectangle(1700 + (num % 3) * 60, 880 + (num / 3) * 60, 60, 60);
					button.DestRect = destRectangle;
					num++;
				}

			}

			if (mOnlySelectedHealthBars && newSelection)
			{
				mHealthbars.Clear();
				// Create healthbars
				foreach (var obj in selectedObjects)
				{
					// Fog of war
					if (obj.FowObject.IsVisible == false) break;

					mHealthbars.Add(new Healthbar(obj, mSelectionButtons, new Vector2(60, 10), mSpriteBatch, false));
					if (obj.Fraction == Fraction.Ai && !(obj is Zone))
					{
						mHealthbars.Add(new Healthbar(obj, mSelectionButtons, new Vector2(60, 10), mSpriteBatch, true));
					}
				}
			}else if (!mOnlySelectedHealthBars && GameScreen.ObjectManager.SelectableObjectsChanged)
			{
				mHealthbars.Clear();
				foreach (var obj in GameScreen.ObjectManager.SelectableObjects)
				{
					// Fog of war
					if (obj.FowObject.IsVisible == false) break;

					mHealthbars.Add(new Healthbar(obj, mSelectionButtons, new Vector2(60, 10), mSpriteBatch, false));
					if (obj.Fraction == Fraction.Ai && !(obj is Zone))
					{
						mHealthbars.Add(new Healthbar(obj, mSelectionButtons, new Vector2(60, 10), mSpriteBatch, true));
					}
				}
			}

			if (selectedObjects.Count == 1)
			{
				WorldObject obj = selectedObjects.First.Value;
				// Load additional info for HUD
				String info = "";
				switch (obj.Fraction)
				{
					case Fraction.Ai:
						info = "Enemy ";
						break;
					case Fraction.Gaia:
						info = "Neutral ";
						break;
					case Fraction.Player:
						info = "Friendly ";
						break;
				}

				switch (obj.Ident)
				{
					case Ident.Spawnzone:
						info += "Spawn Zone\n" + "Captured to " + (int)((((Zone)obj).FractionPoints) / 5d) + "%";
						UpdateSpawnQueue(obj);
						break;
					case Ident.Zone:
						info += "Zone\n" + "Captured to " + (int)((((Zone)obj).FractionPoints) / 5d) + "%";
						break;
					// Atlantican Units
					case Ident.ShieldGuard:
						info += "Shieldguard";
						break;
					case Ident.Priest:
						info += "Priest";
						break;
					case Ident.PriestRanged:
						info += "Ranged Priest";
						break;
					case Ident.EliteAtlantic:
						info += "Elite Atlantican";
						break;
					// Barbarian units
					case Ident.EliteBarbarian:
						info += "Elite Barbarian";
						break;
					case Ident.Axeman:
						info += "Axeman";
						break;
					case Ident.Knight:
						info += "Knight";
						break;
					case Ident.Archer:
						info += "Archer";
						break;
					case Ident.ArcherMounted:
						info += "Mounted Archer";
						break;
				}
				if (obj.Ident != Ident.Zone && obj.Ident != Ident.Spawnzone)
				{
					info += "\nDamage: " + ((Unit) obj).Damage + "\n" + "attackRange: " + ((Unit) obj).AttackRange;
					info += "\n" + "Healthpoints: " + ((Unit) obj).HealthPoints + " / " + ((Unit) obj).MaxHealthPoints;
					if (obj.Fraction == Fraction.Ai)
						info += "\n" + "Faithpoints: " + ((Unit) obj).FaithPoints + " / " + ((Unit) obj).MaxFaithPoints;
#if PIUS
					info += "\n";
					info += "\n" + "mAttacking: " + ((Unit) obj).Attacking;
					info += "\n" + "mAutoAttack: " + ((Unit) obj).AutoAttack;
					info += "\n" + "mDestReached: " + ((Unit) obj).DestinationReached;
#endif
				}

				mThumbNailInfo = new MenuLabel(MenuItem.MenuIdentifier.Label, ScaledRectangle(700, 900, 0, 0), info);
			}

			foreach (var healthbar in mHealthbars)
			{
				healthbar.Update();
			}
			foreach (var thumbnail in mThumbNails)
			{
				thumbnail.Update();
			}

		}

		/// <summary>
		/// updates the spawn queue of the given Spawnzone
		/// </summary>
		/// <param name="obj">spawnZone</param>
		public void UpdateSpawnQueue(WorldObject obj)
		{
#if !PIUS
			if (obj.Fraction != Fraction.Player)
				return;
#endif

			mSpawnQueue = ((SpawnZone)obj).SpawnJobs;

			if (mSpawnQueue.Count > 0)
			{
				mSpawnQueue.First.Value.Update(mSpriteBatch, mSelectionButtons, ScaledRectangle(870, 900, 90, 90));
			}

			int cnt = -1;
			foreach (var job in ((SpawnZone)obj).SpawnJobs)
			{
				if (cnt == -1)
				{
					cnt++;
					continue;
				}
					
				job.Update(mSpriteBatch, mSelectionButtons, ScaledRectangle(960+(cnt%10)*60, 900+(cnt/10)*60, 60 , 60));
				cnt++;
			}
		}

		public Rectangle UpperHudRectangle
		{
			get { return mUpperHudRectangle; }
		}

		public Rectangle LowerHudRectangle
		{
			get { return mLowerHudRectangle; }
		}

		public String DeveloperInfo
		{
			get { return mDeveloperInfo.Text; }
			set { mDeveloperInfo.Text = value; }
		}

		public DeveloperInformation DeveloperInformation { get { return mDeveloperInformation; } }
		public List<Healthbar> GetListOfHealthbar { get { return mHealthbars; } set { mHealthbars = value; } }
	}
}